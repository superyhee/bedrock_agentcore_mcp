# 系统架构文档

## 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户/客户端                              │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         │ HTTP/CLI Request
                         │
┌────────────────────────▼────────────────────────────────────────┐
│                  AgentCore Runtime                               │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │              invoke() 入口函数                            │  │
│  │  • 验证输入                                               │  │
│  │  • 提取 actor_id & session_id                            │  │
│  │  • 配置 Memory                                           │  │
│  └──────────────────────┬───────────────────────────────────┘  │
└─────────────────────────┼──────────────────────────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
        ▼                 ▼                 ▼
┌───────────────┐ ┌──────────────┐ ┌──────────────┐
│  Memory 检索   │ │  工具加载     │ │  提示增强     │
│               │ │               │ │               │
│ • 获取历史    │ │ • 百度地图    │ │ • 注入历史    │
│ • 最近10轮    │ │ • Tavily      │ │ • 构建上下文  │
└───────┬───────┘ └──────┬────────┘ └──────┬────────┘
        │                │                 │
        └────────────────┼─────────────────┘
                         │
                         ▼
        ┌────────────────────────────────┐
        │      Strands Agent             │
        │  • Model: Claude 3.7 Sonnet    │
        │  • Session Manager             │
        │  • System Prompt               │
        │  • Tools                       │
        └────────────┬───────────────────┘
                     │
                     │ stream_async()
                     │
        ┌────────────▼───────────────┐
        │    LLM 推理 & 工具调用      │
        │                            │
        │  ┌──────────────────────┐  │
        │  │  1. 理解用户意图      │  │
        │  │  2. 选择合适工具      │  │
        │  │  3. 执行工具调用      │  │
        │  │  4. 生成响应         │  │
        │  └──────────────────────┘  │
        └────────────┬───────────────┘
                     │
        ┌────────────┼────────────┐
        │            │            │
        ▼            ▼            ▼
┌──────────┐  ┌──────────┐  ┌──────────┐
│百度地图   │  │ Tavily   │  │  Memory  │
│MCP Server│  │   API    │  │  保存    │
└──────────┘  └──────────┘  └──────────┘
        │            │            │
        └────────────┼────────────┘
                     │
                     ▼
        ┌────────────────────────┐
        │    流式响应输出         │
        │  • contentBlockDelta   │
        │  • 实时返回            │
        └────────────┬───────────┘
                     │
                     ▼
        ┌────────────────────────┐
        │      用户/客户端        │
        └────────────────────────┘
```

## 记忆系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                    AgentCore Memory                          │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │              Memory Storage (DynamoDB)                  │ │
│  │                                                         │ │
│  │  /users/{actor_id}/                                    │ │
│  │    ├── facts/          (用户相关事实)                  │ │
│  │    ├── preferences/    (用户偏好)                      │ │
│  │    └── locations/      (位置信息)                      │ │
│  │                                                         │ │
│  │  /sessions/{session_id}/                               │ │
│  │    └── turns/          (对话历史)                      │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │              Retrieval Engine                           │ │
│  │  • Semantic Search (语义搜索)                          │ │
│  │  • Top-K Selection (相关性排序)                        │ │
│  │  • Relevance Scoring (相关性评分)                      │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 对话流程

```
第1轮对话
─────────
用户: "搜索北京天气"
  │
  ├─> Memory 检索: [] (无历史)
  │
  ├─> Agent 处理: "搜索北京天气"
  │
  ├─> 工具调用: tavily_search("北京天气")
  │
  ├─> 响应: "北京今天晴朗，温度 18-25°C"
  │
  └─> Memory 保存:
      • user: "搜索北京天气"
      • assistant: "北京今天晴朗..."

第2轮对话
─────────
用户: "那里有什么景点？"
  │
  ├─> Memory 检索:
  │   [
  │     {"role": "user", "content": "搜索北京天气"},
  │     {"role": "assistant", "content": "北京今天晴朗..."}
  │   ]
  │
  ├─> 提示增强:
  │   "[对话历史]:
  │    1. user: 搜索北京天气
  │    2. assistant: 北京今天晴朗...
  │
  │    [当前问题]:
  │    那里有什么景点？"
  │
  ├─> Agent 处理: 理解"那里"=北京
  │
  ├─> 工具调用: baidu_map_search("北京 景点")
  │
  ├─> 响应: "北京有很多著名景点..."
  │
  └─> Memory 保存:
      • user: "那里有什么景点？"
      • assistant: "北京有很多著名景点..."

第3轮对话
─────────
用户: "从上海怎么去？"
  │
  ├─> Memory 检索: [最近10轮对话]
  │
  ├─> 提示增强: [包含完整上下文]
  │
  ├─> Agent 处理: 理解目的地是北京
  │
  ├─> 工具调用: baidu_map_route("上海", "北京")
  │
  ├─> 响应: "从上海到北京可以..."
  │
  └─> Memory 保存: [继续累积]
```

## 数据流图

```
┌──────────┐
│ 用户输入  │
└────┬─────┘
     │
     ▼
┌─────────────────────┐
│ 1. 提取会话信息      │
│    • actor_id       │
│    • session_id     │
└────┬────────────────┘
     │
     ▼
┌─────────────────────┐
│ 2. 检索对话历史      │
│    • 最近10轮       │
│    • 按时间排序     │
└────┬────────────────┘
     │
     ▼
┌─────────────────────┐
│ 3. 构建增强提示      │
│    • 注入历史       │
│    • 格式化上下文   │
└────┬────────────────┘
     │
     ▼
┌─────────────────────┐
│ 4. Agent 推理       │
│    • 理解意图       │
│    • 选择工具       │
└────┬────────────────┘
     │
     ▼
┌─────────────────────┐
│ 5. 工具执行         │
│    • 百度地图       │
│    • Tavily 搜索    │
└────┬────────────────┘
     │
     ▼
┌─────────────────────┐
│ 6. 生成响应         │
│    • 流式输出       │
│    • 实时返回       │
└────┬────────────────┘
     │
     ▼
┌─────────────────────┐
│ 7. 保存到 Memory    │
│    • 用户输入       │
│    • Agent 回复     │
└────┬────────────────┘
     │
     ▼
┌──────────┐
│ 返回用户  │
└──────────┘
```

## 组件交互

```
┌─────────────────────────────────────────────────────────┐
│                    AgentCore App                         │
│                                                          │
│  ┌────────────────────────────────────────────────────┐ │
│  │              invoke() 入口函数                      │ │
│  │                                                     │ │
│  │  ┌──────────────────────────────────────────────┐ │ │
│  │  │  _get_actor_and_session_id()                 │ │ │
│  │  │  • 从 context 提取用户信息                   │ │ │
│  │  └──────────────────────────────────────────────┘ │ │
│  │                                                     │ │
│  │  ┌──────────────────────────────────────────────┐ │ │
│  │  │  _create_memory_config()                     │ │ │
│  │  │  • 配置 Memory 检索策略                      │ │ │
│  │  └──────────────────────────────────────────────┘ │ │
│  │                                                     │ │
│  │  ┌──────────────────────────────────────────────┐ │ │
│  │  │  _get_conversation_context()                 │ │ │
│  │  │  • 检索对话历史                              │ │ │
│  │  └──────────────────────────────────────────────┘ │ │
│  │                                                     │ │
│  │  ┌──────────────────────────────────────────────┐ │ │
│  │  │  _build_context_aware_prompt()               │ │ │
│  │  │  • 增强用户提示                              │ │ │
│  │  └──────────────────────────────────────────────┘ │ │
│  │                                                     │ │
│  │  ┌──────────────────────────────────────────────┐ │ │
│  │  │  _load_tools()                               │ │ │
│  │  │  • 加载百度地图工具                          │ │ │
│  │  │  • 加载 Tavily 搜索                          │ │ │
│  │  └──────────────────────────────────────────────┘ │ │
│  │                                                     │ │
│  │  ┌──────────────────────────────────────────────┐ │ │
│  │  │  Agent.stream_async()                        │ │ │
│  │  │  • 流式执行                                  │ │ │
│  │  │  • 自动保存历史                              │ │ │
│  │  └──────────────────────────────────────────────┘ │ │
│  └────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

## 工具架构

```
┌─────────────────────────────────────────────────────────┐
│                      Tools Layer                         │
│                                                          │
│  ┌────────────────────┐      ┌────────────────────────┐ │
│  │  Tavily Search     │      │  Baidu Maps MCP        │ │
│  │                    │      │                        │ │
│  │  • tavily_search() │      │  • geocode()           │ │
│  │  • 网络搜索        │      │  • reverse_geocode()   │ │
│  │  • 答案摘要        │      │  • poi_search()        │ │
│  │                    │      │  • route_planning()    │ │
│  │  HTTP API          │      │  • weather_query()     │ │
│  └────────────────────┘      │  • traffic_query()     │ │
│                               │                        │ │
│                               │  MCP Protocol (SSE)    │ │
│                               └────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

## 错误处理流程

```
┌──────────────┐
│  用户请求     │
└──────┬───────┘
       │
       ▼
┌──────────────────┐
│ 验证输入          │
│ • prompt 非空？   │
│ • Memory 配置？   │
└──────┬───────────┘
       │
       ├─ ❌ 验证失败 ──> 返回错误
       │
       ▼ ✅ 验证通过
┌──────────────────┐
│ 检索对话历史      │
└──────┬───────────┘
       │
       ├─ ❌ 检索失败 ──> 记录警告，继续（无历史）
       │
       ▼ ✅ 检索成功
┌──────────────────┐
│ 加载工具          │
└──────┬───────────┘
       │
       ├─ ❌ 加载失败 ──> 记录警告，使用部分工具
       │
       ▼ ✅ 加载成功
┌──────────────────┐
│ Agent 执行        │
└──────┬───────────┘
       │
       ├─ ❌ 执行失败 ──> 返回错误 + 详细日志
       │
       ▼ ✅ 执行成功
┌──────────────────┐
│ 流式返回响应      │
└──────────────────┘
```

## 性能优化策略

```
┌─────────────────────────────────────────────────────────┐
│                    性能优化层                            │
│                                                          │
│  ┌────────────────────────────────────────────────────┐ │
│  │  1. 对话历史限制                                    │ │
│  │     • 只检索最近 10 轮                              │ │
│  │     • 长内容截断（>200字符）                        │ │
│  └────────────────────────────────────────────────────┘ │
│                                                          │
│  ┌────────────────────────────────────────────────────┐ │
│  │  2. 并发处理                                        │ │
│  │     • 历史检索 + 工具加载并行                       │ │
│  │     • 异步 I/O                                      │ │
│  └────────────────────────────────────────────────────┘ │
│                                                          │
│  ┌────────────────────────────────────────────────────┐ │
│  │  3. 超时控制                                        │ │
│  │     • API 请求超时: 30s                             │ │
│  │     • Memory 检索超时: 5s                           │ │
│  └────────────────────────────────────────────────────┘ │
│                                                          │
│  ┌────────────────────────────────────────────────────┐ │
│  │  4. 按需启用                                        │ │
│  │     • use_history=False 跳过历史检索                │ │
│  │     • 独立查询不需要上下文                          │ │
│  └────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

## 部署架构

```
┌─────────────────────────────────────────────────────────┐
│                      AWS Cloud                           │
│                                                          │
│  ┌────────────────────────────────────────────────────┐ │
│  │              Amazon Bedrock                         │ │
│  │  • Claude 3.7 Sonnet                               │ │
│  │  • LLM 推理                                        │ │
│  └────────────────────────────────────────────────────┘ │
│                                                          │
│  ┌────────────────────────────────────────────────────┐ │
│  │         AgentCore Runtime (Serverless)             │ │
│  │  • 自动扩展                                        │ │
│  │  • 负载均衡                                        │ │
│  │  • 流式响应                                        │ │
│  └────────────────────────────────────────────────────┘ │
│                                                          │
│  ┌────────────────────────────────────────────────────┐ │
│  │         AgentCore Memory (DynamoDB)                │ │
│  │  • 对话历史存储                                    │ │
│  │  • 语义搜索                                        │ │
│  │  • 自动备份                                        │ │
│  └────────────────────────────────────────────────────┘ │
│                                                          │
│  ┌────────────────────────────────────────────────────┐ │
│  │         CloudWatch Logs & Metrics                  │ │
│  │  • 日志聚合                                        │ │
│  │  • 性能监控                                        │ │
│  │  • 告警通知                                        │ │
│  └────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

## 安全架构

```
┌─────────────────────────────────────────────────────────┐
│                    安全层                                │
│                                                          │
│  ┌────────────────────────────────────────────────────┐ │
│  │  1. 身份认证                                        │ │
│  │     • AWS IAM                                       │ │
│  │     • Actor ID 隔离                                 │ │
│  └────────────────────────────────────────────────────┘ │
│                                                          │
│  ┌────────────────────────────────────────────────────┐ │
│  │  2. 数据隔离                                        │ │
│  │     • 每个用户独立存储空间                          │ │
│  │     • Session 级别隔离                              │ │
│  └────────────────────────────────────────────────────┘ │
│                                                          │
│  ┌────────────────────────────────────────────────────┐ │
│  │  3. API 密钥管理                                    │ │
│  │     • 环境变量存储                                  │ │
│  │     • 不记录到日志                                  │ │
│  │     • 定期轮换                                      │ │
│  └────────────────────────────────────────────────────┘ │
│                                                          │
│  ┌────────────────────────────────────────────────────┐ │
│  │  4. 数据加密                                        │ │
│  │     • 传输加密 (TLS)                                │ │
│  │     • 存储加密 (DynamoDB)                           │ │
│  └────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

## 监控指标

```
┌─────────────────────────────────────────────────────────┐
│                  监控仪表板                              │
│                                                          │
│  ┌────────────────────────────────────────────────────┐ │
│  │  业务指标                                           │ │
│  │  • 请求总数                                         │ │
│  │  • 成功率                                           │ │
│  │  • 平均响应时间                                     │ │
│  │  • 上下文理解准确率                                 │ │
│  └────────────────────────────────────────────────────┘ │
│                                                          │
│  ┌────────────────────────────────────────────────────┐ │
│  │  技术指标                                           │ │
│  │  • Memory 检索延迟                                  │ │
│  │  • 工具调用次数                                     │ │
│  │  • LLM Token 使用量                                 │ │
│  │  • 错误率                                           │ │
│  └────────────────────────────────────────────────────┘ │
│                                                          │
│  ┌────────────────────────────────────────────────────┐ │
│  │  成本指标                                           │ │
│  │  • API 调用成本                                     │ │
│  │  • Memory 存储成本                                  │ │
│  │  • LLM 推理成本                                     │ │
│  │  • 总成本                                           │ │
│  └────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

## 扩展性设计

```
┌─────────────────────────────────────────────────────────┐
│                  水平扩展                                │
│                                                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐             │
│  │ Runtime  │  │ Runtime  │  │ Runtime  │  ...        │
│  │ Instance │  │ Instance │  │ Instance │             │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘             │
│       │             │             │                     │
│       └─────────────┼─────────────┘                     │
│                     │                                   │
│                     ▼                                   │
│       ┌─────────────────────────┐                      │
│       │   Shared Memory Store   │                      │
│       │   • 无状态设计          │                      │
│       │   • 自动扩展            │                      │
│       └─────────────────────────┘                      │
└─────────────────────────────────────────────────────────┘
```

---

**架构特点**：

- ✅ 模块化设计
- ✅ 松耦合
- ✅ 高可用
- ✅ 可扩展
- ✅ 易维护
